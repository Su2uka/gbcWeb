<!doctype html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- 上述3个meta标签*必须*放在最前面，任何其他内容都*必须*跟随其后！ -->
    <title>ガールズバンドクライ</title>

    <!-- Bootstrap -->
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <link rel="stylesheet" href="css/songs-list.css">
    <link rel="stylesheet" href="css/dialog.css">

    <link rel="icon" href="img/favicon.ico" type="image/x-icon">

    <!-- jQuery (Bootstrap 的所有 JavaScript 插件都依赖 jQuery，所以必须放在前边) -->
    <script src="js/jquery-3.3.1.min.js"></script>
    <!-- 加载 Bootstrap 的所有 JavaScript 插件。你也可以根据需要只加载单个插件。 -->
    <script src="js/bootstrap.min.js"></script>
    <script src="js/include.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
    <script src="js/getParameter.js"></script>
    <script src="js/playerLeftLocation.js"></script>

    <script>
      var likeList = [];

      var currentPageNum;

      var search;

      function like() {
        return new Promise(function(resolve, reject) {
          $.get("like/queryLike", {}, function(list) {
            likeList = list;
            resolve();  // 解决 Promise，表示 `like()` 完成
          }).fail(function() {
            reject();  // 处理错误情况
          });
        });
      }


        $(function () {
            //获取search的参数值
            search = getParameter("search");
            //search不为空或者""，解码,并显示search-feedback
            if (search) {
                search = window.decodeURIComponent(search);

                console.log(search);

                $("#search-content").text(search);
                $(".search-feedback").css('visibility', 'visible');
            } else {
                $(".search-feedback").css('visibility', 'hidden');
            }

          // 首先调用 like，然后在它完成后调用 load
          like().then(function() {
            load(null, search);  // like() 完成后再加载页面内容
          }).catch(function(error) {
            console.error("Error loading like list: ", error);
          });

        });

        function load(currentPage, search) {
            //发送ajax请求
            $.get("song/pageQuery", {currentPage: currentPage, search: search}, function (pb) {
                currentPageNum = currentPage;

                //1.分页工具条展示
                var lis = "";

                var firstPage = '<li onclick="javascript:like(); load(null,\'' + search + '\'); "><a href="javascript:void(0)">首页</a></li>';

                //计算上一页的页码
                var preNum = pb.currentPage - 1;
                if (preNum <= 1) {
                    preNum = 1;
                }

                var prepage = '<li onclick="javascript:like(); load(' + preNum + ',\'' + search + '\'); ">\n' +
                    '          <a href="javascript:void(0);" aria-label="Previous">\n' +
                    '            <span aria-hidden="true">&laquo;</span>\n' +
                    '          </a>\n' +
                    '        </li>';

                lis += firstPage;
                lis += prepage;

                var begin;  //开始位置
                var end;  //结束位置

                //显示5个页码
                if (pb.totalPage < 5) {
                    begin = 1;
                    end = pb.totalPage;
                } else {

                    begin = pb.currentPage - 2;
                    end = pb.currentPage + 2;

                    //如果前面不够2个，后面补齐
                    if (begin < 1) {
                        begin = 1;
                        end = begin + 4;
                    }

                    //如果后面不足2个,前面补齐
                    if (end > pb.totalPage) {
                        end = pb.totalPage;
                        begin = end - 4;
                    }
                }

                for (var i = begin; i <= end; i++) {
                    var li;
                    //判断当前页码是否等于i
                    if (i == pb.currentPage) {
                        li = '<li class="active" onclick="javascript:like(); load(' + i + ',\'' + search + '\');"><a href="javascript:void(0);">' + i + '</a></li>';
                    } else {
                        li = '<li onclick="javascript:like(); load(' + i + ',\'' + search + '\'); "><a href="javascript:void(0);">' + i + '</a></li>';
                    }
                    lis += li;
                }

                //计算下一页的页码
                var nextNum = pb.currentPage + 1;
                if (nextNum >= pb.totalPage) {
                    nextNum = pb.totalPage;
                }

                var nextPage = '<li id="nextPage" onClick="like(); javascript:load(' + nextNum + ',\'' + search + '\');">\n' +
                    '          <a href="javascript:void(0);" aria-label="Next">\n' +
                    '            <span aria-hidden="true">&raquo;</span>\n' +
                    '          </a>\n' +
                    '        </li>';
                var lastPage = '<li onclick="javascript:like(); load(' + pb.totalPage + ',\'' + search + '\');"><a href="javascript:void(0);">末页</a></li>';

                lis += nextPage;
                lis += lastPage;

                $("#pageNum").html(lis);




              //2. 列表数据展示
              var song_lis = "";

              // 播放器当前播放歌曲的 id
              var currentId = $(".audioPlayer").attr('id');
              currentId = parseInt(currentId);  // 确保 currentId 是数字
              var audio = $("#myAudio")[0];

              // 遍历歌曲列表
              for (var i = 0; i < pb.list.length; i++) {
                var song = pb.list[i];
                var li = '';  // 在循环的每次迭代中初始化 li，确保它不会保持上次循环的值

                // 处理播放状态和喜欢状态
                var isPlaying = (song.sid == currentId && isMusicPlaying(audio));
                var isLiked = false;

                // 查找该歌曲是否在 likeList 中
                for (var j = 0; j < likeList.length; j++) {
                  var likeId = likeList[j].sid;
                  /*console.log(likeId);*/
                  if (song.sid == likeId) {
                    isLiked = true;
                    break;
                  }
                }

                // 构建 li 标签
                li += '<li class="song-item" id="' + song.sid + '">\n' +
                        '    <img src="' + song.cover + '" alt="Song Cover" class="song-cover">\n' +
                        '    <div class="song-info">\n' +
                        '        <h5 class="song-title" title="' + song.title + '">' + song.title + '</h5>\n' +
                        '        <p class="song-artist">' + song.artist + '</p>\n' +
                        '        <p class="song-album">' + song.album + '</p>\n' +
                        '    </div>\n' +
                        '    <div class="song-actions">\n' +
                        '        <span class="song-duration">' + song.duration + '</span>\n' +
                        '        <a href="#" class="icon-link download-button">\n' +
                        '            <span class="glyphicon glyphicon-download-alt download-icon"></span>\n' +
                        '        </a>\n';

                // 添加播放按钮
                li += '        <a href="#" class="icon-link play-button">\n' +
                        '            <span class="glyphicon glyphicon-' + (isPlaying ? 'pause' : 'play') + ' play-icon"></span>\n' +
                        '        </a>\n';

                // 添加喜欢按钮
                li += '        <a href="#" class="icon-link like-button">\n' +
                        '            <span class="glyphicon glyphicon-heart like-icon ' + (isLiked ? 'like-active' : '') + '"></span>\n' +
                        '        </a>\n';

                // 添加音频元素
                li += '        <audio src="' + song.filepath + '"></audio>\n' +
                        '    </div>\n' +
                        '</li>';

                // 将 li 添加到 song_lis 中
                song_lis += li;
              }

              // 更新歌曲列表
              $("#song-list").html(song_lis);
            })
        }


    </script>

    <script>
        $(function () {
            const audios = document.querySelectorAll('audio'); // 获取所有的 audio 元素
            const canvas = document.getElementById('visualizer');
            const canvasCtx = canvas.getContext('2d');
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();

            // 创建一个全局的 AnalyserNode
            const analyser = audioContext.createAnalyser();
            analyser.fftSize = 256;

            // 将 AnalyserNode 连接到 AudioContext.destination，只需连接一次
            analyser.connect(audioContext.destination);

            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);

            // 存储每个 audio 元素对应的 MediaElementSourceNode
            const audioSrcMap = new Map();
            let currentAudioSrc = null; // 当前正在连接的 MediaElementSourceNode

            audios.forEach(audio => {
                audio.addEventListener('play', function () {
                    const currentAudio = this;

                    // 如果有之前的音频源，断开其与 analyser 的连接
                    if (currentAudioSrc && currentAudioSrc !== audioSrcMap.get(currentAudio)) {
                        currentAudioSrc.disconnect();
                    }

                    // 检查是否已经为当前音频创建了 MediaElementSourceNode
                    let audioSrc = audioSrcMap.get(currentAudio);
                    if (!audioSrc) {
                        audioSrc = audioContext.createMediaElementSource(currentAudio);
                        audioSrcMap.set(currentAudio, audioSrc);
                    }

                    currentAudioSrc = audioSrc;

                    // 将当前音频源连接到 analyser
                    currentAudioSrc.connect(analyser);

                    // 开始绘制可视化效果
                    audioContext.resume().then(() => {
                        drawVisualizer();
                    });
                });
            });

            function drawVisualizer() {
                requestAnimationFrame(drawVisualizer);
                analyser.getByteFrequencyData(dataArray);

                // 清除之前绘制的内容
                canvasCtx.clearRect(0, 0, canvas.width, canvas.height);

                // 将画布的原点移到左下角并旋转90度（顺时针）
                canvasCtx.save();  // 保存画布的当前状态
                canvasCtx.translate(0, canvas.height); // 移动原点到左下角
                canvasCtx.rotate(-Math.PI / 2); // 顺时针旋转 90 度

                const barWidth = (canvas.height / bufferLength) * 1.5;
                let barHeight;
                let x = 0;

                for (let i = 0; i < bufferLength; i++) {
                    // 增加 barHeight 高度
                    barHeight = (dataArray[i] / 2) * 1.2;  // 20% 增加

                    // 使用黑白灰的颜色基调
                    const grayScale = barHeight + 10; // 灰度值
                    const color = `rgb(${grayScale}, ${grayScale}, ${grayScale})`; // 颜色为黑、白、灰的基调

                    canvasCtx.fillStyle = color;
                    canvasCtx.fillRect(x, canvas.width - barHeight, barWidth, barHeight); // 画出条形

                    x += barWidth + 1;
                }

                canvasCtx.restore(); // 恢复画布的状态
            }
        });

    </script>

    <script>
        var songList = [];

        var playList = [];

        var playList_copy = [];

        // 全局变量定义
        let user = null; // 初始化为 null，表明尚未获取用户信息

        $(function () {
            $.get("user/findOne",{},function (u) {
                user = u;
            });
        });

        $(function () {

            $.get("song/queryAll", {}, function (list) {
                songList = list;
            });

            $.get("song/queryAll", {search: search}, function (list) {
                playList = list;
                // 创建 playList 的副本，避免引用同一个数组对象
                playList_copy = playList.slice();
            });
        });

        $(function () {

            var audio = $("#myAudio")[0];

            //播放器当前播放歌曲的id
            var currentId = $(".audioPlayer").attr('id');
            currentId = parseInt(currentId);  // 确保 currentId 是数字

            // 获取当前点击按钮所在的最近的 li 元素的 id
            var songId;
            /*var songId = $(this).closest('li').attr('id');
            songId = parseInt(songId);  // 确保 songId 是数字*/

            // 初始化进度条
            $("#progress-bar").slider({
                range: "min",
                min: 0,
                max: 100,
                value: 0,
                slide: function (event, ui) {
                    if (audio) {
                        var seekTo = audio.duration * (ui.value / 100); // 计算用户拖动到的播放时间
                        audio.currentTime = seekTo; // 设置音频的当前时间
                    }
                }
            });

            // 更新当前播放时间的函数
            function updateCurrentTime(audio) {
                var currentMinutes = Math.floor(audio.currentTime / 60);
                var currentSeconds = Math.floor(audio.currentTime - currentMinutes * 60);
                if (currentSeconds < 10) {
                    currentSeconds = "0" + currentSeconds;
                }
                $("#current-time").text(currentMinutes + ":" + currentSeconds); // 更新当前播放时间
            }

            //播放按钮
            $(document).on('click', '.play-button', function (e) {
                e.preventDefault(); // 防止默认点击动作

                // 获取当前点击按钮所在的最近的 li 元素的 id
                songId = $(this).closest('li').attr('id');
                songId = parseInt(songId);  // 确保 songId 是数字
                //播放器当前播放歌曲的id
                currentId = $(".audioPlayer").attr('id');
                currentId = parseInt(currentId);  // 确保 currentId 是数字

                //暂停当前播放
                if (songId == currentId && isMusicPlaying(audio)) {
                    audio.pause();
                    return;
                }

                //恢复当前播放
                if (songId == currentId && !isMusicPlaying(audio)) {
                    audio.play();

                    return;
                }

                //首次播放
                if (songId != currentId) {

                    // 显示唱片机
                    $('.record-player').addClass('show');

                    /*for (var i = 0; i < likeList.length; i++) {
                        var likeId = likeList[i].sid;

                        if (likeId == songId) {
                            $("#player-like-button .like-icon").addClass("like-active");
                            break;
                        } else {
                            $("#player-like-button .like-icon").removeClass("like-active");
                        }
                    }*/
                    //更新唱片机喜欢状态
                    playerLike(songId);

                    //更新唱片机
                    updatePlayer(songId);

                }

                //切换播放
                if (currentId != "0" && songId != currentId) {
                    //切换图标样式,切换为暂停图标(上一个播放的按钮)
                    $("#" + $.escapeSelector(currentId) + " .play-button").html('<span class="glyphicon glyphicon-play play-icon"></span>');

                    /*for (var i = 0; i < likeList.length; i++) {
                        var likeId = likeList[i].sid;

                        if (likeId == songId) {
                            $("#player-like-button .like-icon").addClass("like-active");
                            break;
                        } else {
                            $("#player-like-button .like-icon").removeClass("like-active");
                        }
                    }*/

                    //更新唱片机喜欢状态
                    playerLike(songId);

                    // 停止唱片旋转
                    $('.record').removeClass('playing');

                    //更新唱片机
                    updatePlayer(songId);
                }


                $(".audioPlayer").attr('id', songId);
                $("#audioSource").attr('src', songList[songId - 1].filepath);

                // 重新加载音频并播放
                audio.load();  // 重新加载新源
                audio.play();  // 播放音频


            });

            //当点击播放
            audio.addEventListener('play', function () {
                // 更新播放图标为加载中
                $("#" + $.escapeSelector(songId) + " .play-button").html('<img src="img/loading.webp">');
                $("#player-play-button").html('<img src="img/loading.webp">');

                /*// 开始唱片旋转
                $('.record').addClass('playing');*/
            });

            // 当音频开始播放时
            audio.addEventListener('playing', function () {
                // 更新播放图标为暂停图标
                $("#" + $.escapeSelector(songId) + " .play-button").html('<span class="glyphicon glyphicon-pause play-icon"></span>');
                $("#player-play-button").html('<span class="glyphicon glyphicon-pause play-icon"></span>');


                // 开始唱片旋转
                $('.record').addClass('playing');
            });

            // 当音频暂停时
            audio.addEventListener('pause', function () {
                // 进行暂停图标切换操作
                $("#" + $.escapeSelector(songId) + " .play-button").html('<span class="glyphicon glyphicon-play play-icon"></span>');
                $("#player-play-button").html('<span class="glyphicon glyphicon-play play-icon"></span>');

                // 停止唱片旋转
                $('.record').removeClass('playing');
            });

            // 每当音频播放进度更新时，更新进度条和当前时间
            audio.addEventListener('timeupdate', function () {
                var value = (audio.currentTime / audio.duration) * 100; // 计算当前播放进度百分比
                $("#progress-bar").slider("value", value); // 更新进度条的当前值
                updateCurrentTime(audio); // 更新当前时间
            });

            // 当音频播放结束时，停止旋转并恢复播放按钮
            audio.addEventListener('ended', function () {
                $('.play-button').html('<span class="glyphicon glyphicon-play play-icon"></span>'); // 恢复所有播放图标
                $('.record').removeClass('playing'); // 停止唱片旋转
                $("#current-time").text("0" + ":" + "00"); // 更新进度条当前时间
                $("#progress-bar").slider("value", 0); // 将进度条重置为 0

                //正在播放歌曲的id
                currentId = $(".audioPlayer").attr('id');
                currentId = parseInt(currentId);

                //顺序播放
                if (currentModeIndex==0) {
                    //是否到了播放列表最末尾
                    if (currentId == playList[playList.length-1].sid) {
                        //到了
                        return;
                    }

                    //没有到最末尾
                    for (var i = 0; i < playList.length; i++) {
                        if (currentId == playList[i].sid){
                            songId = playList[i+1].sid;
                            break;
                        }
                    }
                } else if (currentModeIndex == 1) {  //单曲循环
                    songId = currentId;
                } else if (currentModeIndex == 2) {  //随机播放
                    for (var i = 0; i < playList.length; i++) {
                        if (currentId == playList[i].sid){
                            if (i < (playList.length-1)) {
                                songId = playList[i+1].sid;
                                break;
                            }
                            songId = playList[0].sid;
                        }
                    }
                } else {  //列表循环
                    for (var i = 0; i < playList.length; i++) {
                        if (currentId == playList[i].sid){
                            if (i < (playList.length-1)) {
                                songId = playList[i+1].sid;
                                break;
                            }
                            songId = playList[0].sid;
                        }
                    }
                }

                $(".audioPlayer").attr('id', songId);
                $("#audioSource").attr('src', songList[songId - 1].filepath);

                //更新唱片机喜欢状态
                playerLike(songId);

                updatePlayer(songId);

                // 重新加载音频并播放
                audio.load();  // 重新加载新源
                audio.play();  // 播放音频

            });





            //唱片机播放按钮
            $("#player-play-button").click(function (e) {
                e.preventDefault(); // 防止默认点击动作

                if (isMusicPlaying(audio)) {
                    audio.pause();
                    $("#player-play-button").html('<span class="glyphicon glyphicon-play play-icon"></span>');
                } else {
                    audio.play();
                    $("#player-play-button").html('<span class="glyphicon glyphicon-pause play-icon"></span>');
                }

            });

            //监听空格暂停
            document.addEventListener('keydown', function(event) {
                if (event.key === ' ' || event.keyCode === 32) {
                    event.preventDefault(); // 防止页面滚动
                    /*alert('空格键被按下了！');*/

                    $("#player-play-button").click();
                }
            });

            //喜欢按钮
            $(document).on('click', '.like-button', async function (e) {
                e.preventDefault(); // 防止默认点击动作

                var button = $(this);

                // 禁用按钮，避免重复点击
                button.prop("disabled", true);

                // 获取当前点击按钮所在的最近的 li 元素的 id
                var songId = $(this).closest('li').attr('id');
                var search = getParameter("search");

                // 如果 search 存在，进行解码
                if (search) {
                    search = decodeURIComponent(search); // 对 URL 编码进行解码
                }


                try {
                    // 判断用户是否登录
                    /*user = await $.get("user/findOne");*/
                    if (!user) {
                        // 用户未登录
                        showDialog();
                        return;
                    }

                    // 判断是否已经喜欢
                    const info = await $.get("like/checkLike", { sid: songId, uid: user.uid });

                    var playerID = $(".audioPlayer").attr('id')

                    // 根据是否喜欢，执行相应的操作
                    if (info.flag) {
                        await toggleLike(false, songId, user.uid);

                        if (songId == playerID) {
                            $("#player-like-button .like-icon").removeClass("like-active");
                        }

                    } else {
                        await toggleLike(true, songId, user.uid);

                        if (songId == playerID) {
                            $("#player-like-button .like-icon").addClass("like-active");
                        }

                    }

                    // 喜欢/取消喜欢完成后刷新内容
                    await like();
                    await load(currentPageNum, search);

                } catch (error) {
                    console.error("An error occurred:", error);
                } finally {
                    // 请求完成后，重新启用按钮
                    button.prop("disabled", false);
                }
            });


            // 播放器喜欢按钮
            $("#player-like-button").click(async function (e) {
                e.preventDefault(); // 防止默认点击动作

                if (!user) {
                    // 用户未登录
                    showDialog();
                    return;
                }


                var songId = $(".audioPlayer").attr('id');
                var userId = user.uid;  // 假设用户对象已存在，并且包含 uid
                var likeButton = $("#" + $.escapeSelector(songId) + " .like-button");
                var playerLikeButton = $(this);  // 当前按钮引用

                // 禁用按钮，避免重复点击
                playerLikeButton.prop("disabled", true);

                try {
                    if (likeButton.length) {
                        // 如果歌曲在页面中，模拟点击 likeButton
                        likeButton.click();

                        // 等待 likeButton 的点击事件完成
                        await new Promise(resolve => setTimeout(resolve, 100)); // 等待 100ms，确保状态更新

                        // 检查喜欢状态并更新播放器喜欢按钮的图标
                        if (likeButton.find(".like-icon").hasClass("like-active")) {
                            // 已喜欢，移除 like-active 类
                            $("#player-like-button .like-icon").removeClass("like-active");
                        } else {
                            // 未喜欢， 添加like-active 类
                            $("#player-like-button .like-icon").addClass("like-active");
                        }
                    } else {
                        // 歌曲不在页面中，检查是否已喜欢
                        const info = await $.get("like/checkLike", { sid: songId, uid: userId });
                        const isLiked = info.flag; // true 表示已喜欢

                        // 调用通用的 toggleLike 函数，切换喜欢状态
                        await toggleLike(!isLiked, songId, userId);

                        // 更新播放器喜欢按钮的图标
                        if (isLiked) {
                            // 已经喜欢，取消喜欢并移除 like-active 类
                            $("#player-like-button .like-icon").removeClass("like-active");
                        } else {
                            // 未喜欢，添加喜欢并添加 like-active 类
                            $("#player-like-button .like-icon").addClass("like-active");
                        }
                    }
                } catch (error) {
                    console.error("操作失败:", error);
                } finally {
                    // 操作完成后，重新启用按钮
                    playerLikeButton.prop("disabled", false);
                }
            });


            //下载按钮
            $(document).on('click','.download-button',function (e) {
                e.preventDefault(); // 防止默认点击动作

                if (!user) {
                    // 用户未登录
                    showDialog();
                    return;
                }

                var songId = $(this).closest('li').attr('id');
                songId = parseInt(songId);  // 确保 songId 是数字

                $.get("song/download",{sid:songId},function (link) {

                    if (link != null && link.length>0)  {
                        location.href = link;
                    } else {
                        showDLD();
                    }

                });

            });

            //唱片机下载按钮
            $("#player-download-button").click(function (e) {
                e.preventDefault(); // 防止默认点击动作

                if (!user) {
                    // 用户未登录
                    showDialog();
                    return;
                }

                var songId = $(".audioPlayer").attr('id');

                var downloadButton = $("#" + $.escapeSelector(songId) + " .download-button");

                if (downloadButton.length) {
                    // 如果歌曲在页面中，模拟点击
                    downloadButton.click();
                } else {
                    $.get("song/download",{sid:songId},function (link) {
                        if (link != null && link.length>0)  {
                            location.href = link;
                        } else {
                            showDLD();
                        }
                    });
                }
            });

            //唱片机向后按钮
            $("#player-backward-button").click(function (e) {
                e.preventDefault(); // 防止默认点击动作

                // 停止唱片旋转
                $('.record').removeClass('playing');

                //正在播放歌曲的id
                currentId = $(".audioPlayer").attr('id');
                currentId = parseInt(currentId);
                //console.log("currentId:"+currentId);

                for (var i = 0; i < playList.length; i++) {
                    if (currentId == playList[i].sid){
                        if (i != 0) {
                            songId = playList[i-1].sid;
                            break;
                        }
                        songId = playList[playList.length-1].sid;
                    }
                }

                songId = parseInt(songId);
                //console.log("songId:"+songId);


                $("#" + $.escapeSelector(currentId) + " .play-button").html('<span class="glyphicon glyphicon-play play-icon"></span>');

                $(".audioPlayer").attr('id', songId);
                $("#audioSource").attr('src', songList[songId - 1].filepath);


                //更新唱片机喜欢状态
                playerLike(songId);

                updatePlayer(songId);

                // 重新加载音频并播放
                audio.load();  // 重新加载新源
                audio.play();  // 播放音频


            });

            //唱片机向前按钮
            $("#player-forward-button").click(function (e) {
                e.preventDefault(); // 防止默认点击动作

                // 停止唱片旋转
                $('.record').removeClass('playing');

                //正在播放歌曲的id
                currentId = $(".audioPlayer").attr('id');
                currentId = parseInt(currentId);
                //console.log("currentId:"+currentId);

                for (var i = 0; i < playList.length; i++) {
                    if (currentId == playList[i].sid){
                        if (i < (playList.length-1)) {
                            songId = playList[i+1].sid;
                            break;
                        }
                        songId = playList[0].sid;
                    }
                }

                songId = parseInt(songId);
                //console.log("songId:"+songId);


                $("#" + $.escapeSelector(currentId) + " .play-button").html('<span class="glyphicon glyphicon-play play-icon"></span>');

                $(".audioPlayer").attr('id', songId);
                $("#audioSource").attr('src', songList[songId - 1].filepath);

                //更新唱片机喜欢状态
                playerLike(songId);

                updatePlayer(songId);

                // 重新加载音频并播放
                audio.load();  // 重新加载新源
                audio.play();  // 播放音频

            });



            //唱片机播放模式切换

            // 定义四种模式对应的图片路径
            var modes = [
                "img/playMode/shuiXuPlay.png",    // 顺序播放
                "img/playMode/danQuXunHuan.png",  // 单曲循环
                "img/playMode/suiJiPlay.png",     // 随机播放
                "img/playMode/lieBiaoXunHuan.png"  // 列表循环
            ];


            // 定义模式的名称，用于更新 title 属性
            var modeTitles = [
                "顺序播放",
                "单曲循环",
                "随机播放",
                "列表循环"
            ];

            // 当前模式的索引
            var currentModeIndex = 0;


            //唱片机播放模式切换
            $("#player-playMode-button").click(function (e) {
                // 防止默认事件（如果有需要）
                e.preventDefault();

                //console.log(playList);

                // 更新当前模式索引，循环从 0 开始
                currentModeIndex = (currentModeIndex + 1) % modes.length;

                if (currentModeIndex == 2) { //对应随机播放
                    playList = shuffleArray(playList.slice()); // 重新洗牌副本，避免修改原数组
                } else {
                    playList = playList_copy.slice(); // 恢复原始顺序，创建副本
                }

                // 更新图片的 src 属性
                $(".playMode-icon-img").attr("src", modes[currentModeIndex]);

                // 更新按钮的 title 属性
                $(this).attr("title", modeTitles[currentModeIndex]);
            });


        });

        //唱片机喜欢图标状态
        function playerLike(songId) {
            for (var i = 0; i < likeList.length; i++) {
                var likeId = likeList[i].sid;

                if (likeId == songId) {
                    $("#player-like-button .like-icon").addClass("like-active");
                    break;
                } else {
                    $("#player-like-button .like-icon").removeClass("like-active");
                }
            }
        }

        // 定义洗牌函数
        function shuffleArray(array) {
            for (var i = array.length - 1; i > 0; i--) {
                // 生成 0 到 i 之间的随机整数
                var j = Math.floor(Math.random() * (i + 1));
                // 交换元素 array[i] 和 array[j]
                var temp = array[i];
                array[i] = array[j];
                array[j] = temp;
            }
            return array;
        }

        // 通用的喜欢/取消喜欢函数
        async function toggleLike(isLike, songId, userId) {
            if (isLike) {
                // 添加喜欢
                await $.get("like/addLike", { sid: songId, uid: userId });
            } else {
                // 取消喜欢
                await $.get("like/cancelLike", { sid: songId, uid: userId });
            }
        }

        function isMusicPlaying(audioElement) {
            // 判断音乐是否在播放，返回布尔值
            return !audioElement.paused; // 如果 paused 为 false，说明正在播放，返回 true
        }

        //更新唱片机样式
        function updatePlayer(songId) {
            //唱片机显示总时长
            $("#total-duration").text(songList[songId - 1].duration);
            //显示标题
            $("#current-song-title").text(songList[songId - 1].title); // 更新到界面
            $("#current-song-title").attr('title', songList[songId - 1].title); // 设置 title 属性
            //显示封面
            $("#recordCover").attr('src', songList[songId - 1].cover);
        }

        // 绑定双击事件
        $(document).on('dblclick', '.song-item', function(e) {
            // 获取双击的目标元素
            var target = $(e.target);

            if (!target.closest('.song-actions').length) {
                // 如果双击的不是指定要排除的元素，则触发逻辑
                $(this).find('.play-button').click();
            }
        });

    </script>


    <script>
      // 显示 mydialog
      function showDialog() {
        document.getElementById("myDialog").showModal();
      }

      // 关闭 mydialog
      function closeDialog() {
        document.getElementById("myDialog").close();
        location.href = "login.html";
      }

      function showDLD() {
          document.getElementById("downloadDialog").showModal();
      }

      function closeDLD() {
          document.getElementById("downloadDialog").close();
      }

    </script>



    <!-- dialog 模态框 -->
    <dialog id="myDialog">
      <div class="modal-header">
        <h2>温馨提示</h2>
      </div>
      <div class="modal-body">
        <p>未登录！</p>
      </div>
      <div class="modal-footer">
        <button class="close-btn" onclick="closeDialog()">关闭</button>
      </div>
    </dialog>

    <!-- dialog 模态框 -->
    <dialog id="downloadDialog">
        <div class="modal-header">
            <h2>温馨提示</h2>
        </div>
        <div class="modal-body">
            <p>暂时没有资源QAQ</p>
        </div>
        <div class="modal-footer">
            <button class="close-btn" onclick="closeDLD()">关闭</button>
        </div>
    </dialog>
</head>
<body>
<div id="header"></div>
<div class="container-fluid">
    <div class="col-md-2">
        <div class="record-player">
            <div class="record">
                <img id="recordCover" src="" alt="Song Cover" class="record-cover">
            </div>

            <!-- 当前歌曲标题 -->
            <div id="current-song-title" class="song-title-display" title=""></div>
            <!-- 进度条容器 -->
            <div id="progress-bar-container">
                <span id="current-time">00:00</span> <!-- 当前播放时间 -->
                <div id="progress-bar"></div>
                <span id="total-duration">00:00</span> <!-- 音频总时间 -->
            </div>
            <!-- 图标链接容器 -->
            <div class="icon-container">
                <a href="#" class="icon-link" title="顺序播放" id="player-playMode-button" >
                    <span class="playMode-icon" ><img src="img/playMode/shuiXuPlay.png" class="playMode-icon-img"></span>
                </a>
                <a href="#" class="icon-link " id="player-backward-button">
                    <span class="glyphicon glyphicon-step-backward backward-icon"></span>
                </a>
                <a href="#" class="icon-link " id="player-play-button">
                    <span class="glyphicon glyphicon-play play-icon"></span>
                </a>
                <a href="#" class="icon-link" id="player-forward-button">
                    <span class="glyphicon glyphicon-step-forward forward-icon"></span>
                </a>
                <a href="#" class="icon-link " id="player-like-button">
                    <span class="glyphicon glyphicon-heart like-icon"></span>
                </a>
            </div>
        </div>
    </div>
    <div class="col-md-8">
        <div class="search-feedback">
            <span class="glyphicon glyphicon-search"></span>
            <span id="search-content"></span>
            <span class="glyphicon glyphicon-chevron-right"></span>
            <span>搜索结果</span>
        </div>

        <div id="0" style="display: none" class="audioPlayer">
            <audio id="myAudio">
                <source id="audioSource" src="" type="audio/mpeg">
            </audio>
        </div>

        <ul class="song-list" id="song-list">

        </ul>


        <nav aria-label="Page navigation" class="page-navigation">
            <ul class="pagination pagination-lg" id="pageNum">
                <li>
                    <a href="#">首页</a></li>
                </li>
                <li>
                    <a href="#" aria-label="Previous">
                        <span aria-hidden="true">&laquo;</span>
                    </a>
                </li>
                <li class="active"><a href="#">1</a></li>
                <li><a href="#">2</a></li>
                <li><a href="#">3</a></li>
                <li><a href="#">4</a></li>
                <li><a href="#">5</a></li>
                <li>
                    <a href="#" aria-label="Next">
                        <span aria-hidden="true">&raquo;</span>
                    </a>
                </li>
                <li>
                    <a href="#">尾页</a></li>
                </li>
            </ul>
        </nav>
    </div>
    <div class="col-md-2" style="position: relative;z-index: -1">
        <canvas id="visualizer" width="1000" height="600"
                style="position: fixed; right: 0; top: 50%; transform: translateY(-50%);"></canvas>
    </div>
</div>

</body>
</html>